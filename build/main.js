const e=e=>document.querySelector(e),o=e=>document.querySelectorAll(e),n=(e,o,n)=>e.addEventListener(o,n),t=(e,o,n)=>{const t=document.createElement(e);return t.classList.add(o),t.innerHTML=n,t},a=(o,t,s,r)=>{if(e(`.log#${r} .new`))return void setTimeout(()=>a(o,t,s,r),500);const i=document.createElement("p");i.innerHTML=`<span class="icon">${s}</span><span class="${t}">${o}</span>`,t&&i.classList.add(t),i.classList.add("new"),e(`.log#${r}`).prepend(i),"restart"===t&&n(i,"click",y),setTimeout(()=>{i.classList.remove("new")},200)},s=o=>{e(o).style.visibility="visible"},r=o=>{e(o).style.visibility="hidden"},i=e=>{let o=0,n=0,t=null;for(o=e.length-1;o>0;o-=1)n=Math.floor(Math.random()*(o+1)),t=e[o],e[o]=e[n],e[n]=t;return e};let l=[];const d=(e,o)=>{l.push(setTimeout(e,o))};let c=[];const u=(e,o)=>{c.push(setInterval(e,o))},p=()=>{l.forEach(clearTimeout),l=[],c.forEach(clearInterval),c=[],clearInterval(ce),clearInterval(ue)},h=()=>{p(),document.body.style.setProperty("--v","0"),o("button").forEach(e=>e.style.visibility="hidden"),o(".project").forEach(e=>e.remove()),e("#island").innerHTML=N,o(".log").forEach(e=>e.innerHTML=""),e("#island").style.filter=null,r("#score-board"),z();for(const e in F)F[e]instanceof Object?Object.assign(window[e],F[e]):window[e]=F[e]},g={foragers:0,foraging:0,hunters:0,hunting:0,loggers:0,wood:0},f=()=>{const n=(B.getTime()-F.date.getTime())/864e5,t=e("#leave").disabled,a=o(".project.done").length,r=["Days taken",n,"Population saved",I.total,"Projects completed",a,"Went back to the sea",t?"Yes":"No"];t&&(r.push("Survived wrath of god"),r.push(W<=A?"Yes":"No"));const i=Math.ceil((10*I.total+a-n+(t?10:0))*(1-W));e("#score-board .modal .content").innerHTML=r.map(e=>`<span>${e}</span>`).join("")+`<p>Final Score</p><p>${i} pts</p>`,s("#score-board")},m=(o,n,t,r)=>()=>{g[o]+=t,T();const i=Math.random()<r*H;i?(a(`Wild animals killed ${K().name} while ${"wood"==o?"logging":o}`,"red","💀","info"),I.ready+=n-1,I.total-=1,$("population","red")):I.ready+=n,oe.weapons.unlocked||!i&&"hunting"!==o||(oe.weapons.unlocked=!0,a("Hunters found dangerous animals; they could use some extra protection","blue","🛡","info"),$("projects","blink"),ie("weapons")),"foraging"===o&&x.food>80&&!_&&(s("#hunt"),$("hunt","blink"),_=!0,a("Animals were sighted far in the valleys, hunting may be possible.","blue","🏹","info")),"wood"===o&&!oe.carpentry.unlocked&&x.wood>5&&(oe.carpentry.unlocked=!0,a("Develop carpentry to process wood more efficiently","blue","🔨","info"),ie("carpentry"),$("projects","blink")),D||"wood"!==o||(e("animate").beginElement(),D=!0,a("The crew rejoices the arrival of wood for cooking and heating.",null,"🔥","info"),O.push(()=>{x.wood>0&&(x.wood=Math.max(0,x.wood-2),$("wood","red"))})),X()};function y(){h(),fe()}const v={leave:()=>{a(`${I.total} people board the caravela and get ready for departure`,null,"⛵️","info"),e("#newShip").classList.add("go"),I.ready=0,X(),p(),d(W>.2?()=>{a("A violent storm suddenly forms. The ship capsizes and sinks. There were no survivors.",null,"⛈","info"),I.total=0,X(),he(),d(f,2e3)}:()=>{a("The journey back was long. They experienced perfect weather and ideal winds.",null,"🌤","info"),a("Fim.",null,"🌅","info")},7e3)},fetchWood:()=>{I.ready-=1;const e=.6*R;d(m("wood",1,3,.05),e),g.loggers++,T(),X(),V(e,"forageTemplate",!0)},pray:()=>{I.ready-=1,C=!0,d(()=>{I.ready+=1,C=!1,W*=.7;const e=G();a(`${e.name} is feeling envigorated after a day at the house of God. Praise the Lord!`,null,"✝️","info")},R)},forage:()=>{I.ready-=1;const e=.4*R;d(m("foraging",1,q,0),e),g.foragers++,T(),X(),V(e,"forageTemplate",!0)},hunt:()=>{I.ready-=2;const e=1.2*R;d(m("hunting",2,20,.1),e),g.hunters+=2,T(),X(),V(e,"huntTrail",!0)},restart:y},b=()=>{o(".actions button").forEach(e=>{n(e,"click",v[e.id])}),n(e("#projects"),"click",()=>{e(".projects").classList.toggle("closed"),e("#requirements").innerText=null}),n(e("#score-board button"),"click",y)},w={wood:{r:"wood",e:"🌳"},foraging:{r:"food",e:"🌾"},hunting:{r:"food",e:"🏹"}},k=e=>{g[e]<1||(a(`+${g[e]}`,"green",w[e].e,"tasks"),x[w[e].r]+=g[e],g[e]=0,$(w[e].r,"green"))},T=()=>{clearInterval(S),S=setInterval(()=>{["foraging","hunting","wood"].forEach(k),g.foragers&&(a(`${g.foragers}👤 went foraging.`,null,"🌾","tasks"),g.foragers=0),g.hunters&&(a(`${g.hunters}👥 went hunting .`,null,"🏹","tasks"),g.hunters=0),g.loggers&&(a(`${g.loggers}👤 went logging.`,null,"🌳","tasks"),g.loggers=0),X()},P)},$=(o,n)=>{e(`#${o}`).classList.add(n),d(()=>{e(`#${o}`).classList.remove(n)},"no"===n?400:100)},j=()=>{let e=x.food-I.total;if($("food","red"),e>=0)I.hungry=I.starving,I.starving=0,x.food=e;else{const o=Math.min(I.starving,-e);o>0&&(a(`${Q(o).map(e=>e.name).join(", ")} died from starvation.`,"red","💀","info"),I.total-=o,I.ready-=o,I.starving=0,$("population","red"));const n=Math.min(I.hungry,-e);I.hungry=Math.min(I.total-n,-e),n>0?(I.starving=n,a(`${n} are starving and can't work.`,"red","😔","info")):I.hungry>0&&a(`${G().name} ${I.hungry>2?`and ${I.hungry-1} others are`:"is"} getting hungry`,null,"💭","info"),x.food=0}},L=e=>I.ready-I.starving>=e,E=()=>{if(Z(),j(),I.total<1)return a("Your population was decimated. <strong>Restart?<strong>","restart","☠️","info"),he(),void X();O.forEach(e=>e()),X()},M=()=>{e("#island").classList.toggle("night")};var x={wood:0,food:0},I={total:15,ready:15,hungry:0,starving:0,fishers:0},q=2,_=!1,D=!1,H=1,P=400,S=null,W=1,A=.2,C=!1,O=[],R=1e4,B=new Date("1549/08/13");const F={resources:Object.assign({},x),population:Object.assign({},I),foragingReturns:q,huntingEnabled:_,smokeEnabled:D,attackChance:H,bufferTimeout:P,bufferInterval:S,godsWrath:W,isPraying:C,date:new Date(B),dayEvents:O},N=e("#island").innerHTML,Y=i([["Abraão","👨🏻‍🦱"],["Bartolomeu","👨🏼‍🦱"],["João","👨🏻"],["Jacinto","🧔🏽"],["Paulo","👴🏼"],["Tiago","👦🏻"],["Isaías","🧑🏻"],["Henrique","👨🏼‍🦰"],["Tomás","🧓🏼"],["Amélia","👩🏼‍🦳"],["Camila","👩🏾‍🦱"],["Benedita","👩🏻‍🦱"],["Madalena","👩🏻"],["Teresa","👩🏼"],["Lúcia","👩🏼‍🦰"]]).reduce((o,n)=>{const a=t("div","icon",n[1]);return a.id=n[0],a.title=n[0],e(".people").append(a),o.push({name:n[0],alive:!0}),o},[]),z=()=>{Y.map(o=>{o.alive=!0,e(`#${o.name}`).classList.remove("dead")})};let J=0;const G=()=>{const e=Y.filter(e=>e.alive);return e[Math.round(Math.random()*(e.length-1))]},K=()=>{J++;const o=G();return o.alive=!1,e(`#${o.name}`).classList.add("dead"),o},Q=e=>{const o=[];for(let n=0;n<e;n++)o.push(K());return o};let U=0;const V=(o,n,t)=>{const a=t?e(`#${n}`).cloneNode():e(`#${n}`);let s=n;t&&(s="trail"+ ++U,a.id=s,e(`#${n}`).after(a)),setTimeout(()=>{const o=Math.round(e(`#${n}`).getTotalLength());a.style.strokeDasharray="huntTrail"==n?`0,${o}px,0.5,1,0.5,1,0.5,1,0.5,100%`:`0,${o}px,${"boatTrail"==n?2:1}`},100),setTimeout(()=>{e(`#${s}`).style.strokeDasharray=null},o/2),t&&setTimeout(()=>{e(`#${s}`).remove()},o)},X=()=>{e("#wood .value").innerText=x.wood,e("#food .value").innerText=x.food,e("#population .value").innerText=I.total,e("#ready .value").innerText=Math.max(0,I.ready-I.starving),e("#starving .value").innerText=I.starving,I.starving<1?e("#starving").classList.add("hidden"):e("#starving").classList.remove("hidden"),e("#fishers .value").innerText=I.fishers,I.fishers<1?e("#fishers").classList.add("hidden"):e("#fishers").classList.remove("hidden"),e("#forage").disabled=!L(1),e("#fetchWood").disabled=!L(1),e("#hunt").disabled=!L(2),e("#pray").disabled=!L(1)||C},Z=()=>{B.setDate(B.getDate()+1),e("#days .value").innerText=`${B.getDate()} / ${B.getMonth()+1} / ${B.getFullYear()}`},ee=()=>{e("#sail").beginElement(),e("#sink").beginElement(),e("#sinkRotate").beginElement()},oe={fishing:{emoji:"🎣",done:!1,unlocked:!0,cost:{wood:10,food:10,people:4,days:2},description:"Develop fishing tools (+3 food per day)",callback:()=>{a("Fishing preparations have been developed (+3 food per day).","blue","🎣","info"),s("#fh"),I.ready-=1,I.fishers++,u(()=>{V(R/3,"fishTrail",!1)},R/3),O.push(()=>{x.food+=3,a("+3🍒","blue","🐟","tasks")})}},high_sea_fishing:{emoji:"⛵️",done:!1,unlocked:!0,requires:["shipyard","fishing"],cost:{wood:25,food:10,people:5,days:5},description:"Build a fishing boat (+5 food per day).",callback:()=>{I.ready-=1,I.fishers++,s("#boatTrail"),u(()=>{V(R/2,"boatTrail",!1)},R/2),O.push(()=>{x.food+=5,a("+5🍒","blue","🐟","tasks")})}},carpentry:{emoji:"🔨",done:!1,unlocked:!1,cost:{wood:10,food:10,people:4,days:2},description:"Recycle and process wood more efficiently (+5 wood per day)",callback:()=>{a("Carpentry was perfected, new buildings are now available.","blue","🔨","info"),$("projects","blink"),ie("shipyard"),ie("spinning_wheel"),ie("chapel"),O.push(()=>{x.wood+=5,a("+5🌳","blue","🔨","tasks")})}},weapons:{emoji:"🛡",done:!1,unlocked:!1,description:"Produce weapons and armor (-75% chance of animal attack deaths)",cost:{wood:50,food:15,people:4,days:2},callback:()=>{H*=.25}},spinning_wheel:{emoji:"🧶",done:!1,unlocked:!0,description:"Some foragers will start gathering fibers, spinning into thread, producing cloth. (-50% food from foraging)",cost:{wood:10,food:20,people:2,days:3},callback:()=>{a("Foragers have started producing cloth from fibers.","blue","🧶","info"),q-=1,e("#forage .return").innerText=q,$("foraging","blink"),ne()}},shipyard:{emoji:"⚓",done:!1,unlocked:!0,requires:["carpentry"],cost:{wood:100,food:10,people:5,days:7},description:"Build a shipyard where boats and ships can be built.",callback:()=>{a("The shipyard construction has finished!","blue","⚓","info"),s("#sy"),ie("high_sea_fishing"),ne()}},caravela:{description:"Build a caravela and return home. Requires a shipyard, carpentry, textiles, as well as food for the trip.",emoji:"🌊",done:!1,unlocked:!1,requires:["shipyard","spinning_wheel"],cost:{wood:100,food:200,people:10,days:8},callback:()=>{a("The Caravela construction is complete! Shall we?","green","🌊","info"),s("#newShip"),s("#leave")}},chapel:{description:"A place where people can gather to support, encorage and service each other.",requires:["carpentry"],emoji:"🙏",cost:{wood:20,food:20,people:3,days:3},callback:()=>{W-=.5,s("#pray"),s("#cp")}}},ne=()=>{oe.spinning_wheel.done&&oe.shipyard.done&&(a("The caravela construction project is in sight!","green","🌊","info"),oe.caravela.unlocked=!0)},te={foraging:["foraging"],fishing:["fishing","fish_boat","high_sea_fishing"],hunting:["hunting","traps","farming"]},ae=()=>{Object.keys(oe).forEach(e=>{oe[e].unlocked&&ie(e)})},se={wood:"🌳",food:"🍒",days:"days ⏳",people:"👫"},re=e=>Object.keys(e).map(o=>`${e[o]} ${se[o]}`).join("  "),ie=o=>{const a=oe[o],s=t("div","project",null);s.id=o,s.innerHTML=`\n  <div class="icon">${a.emoji}</div>\n  <div class="title caps">${o.replace(/_/g," ")}</div>\n  <small class="description">${a.description}</small>\n  <div class="cost">${re(a.cost)}</div>`,e(".projects").append(s),n(s,"click",de(o))},le=()=>{},de=o=>()=>{if(e(".projects").classList.contains("closed"))return void e(".projects").classList.remove("closed");const n=oe[o];if(n.done)return;if("caravela"===o&&!n.unlocked){const n=oe.caravela.requires.filter(e=>!oe[e].done).map(e=>`[${e.replace(/_/g," ")}]`);if(n.length>0){$(o,"no");const t=`Construction of the new caravela requires ${n.join(" and ")}.`;return e("#requirements").innerText=t,void a(t,null,"❌","info")}}const t=["wood","food"].filter(e=>x[e]<n.cost[e]);if(t.length>0){$(o,"no");const n=`There is not enough ${t.join(" and ")} to start the ${o} project`;return e("#requirements").innerText=n,void a(n,null,"❌","info")}if(!L(n.cost.people)){if("caravela"!==o){const n=`Not enough people ready to start the ${o} project`;return e("#requirements").innerText=n,void a(n,null,"❌","info")}{const e=I.ready-I.starving,o=n.cost.people*n.cost.days,t=Math.ceil(o/e);a(`The Caravela contruction started, but with only ${e} people, it will take ${t} days.`,null,"⚒","info"),n.cost.people=e,n.cost.days=t}}x.wood-=n.cost.wood,x.food-=n.cost.food,I.ready-=n.cost.people,n.done=!0;const s=e(`.project#${o}`),r=n.cost.days*R;s.style.transition=`height ${r}ms linear`,s.classList.add("in-progress"),e(".projects").classList.add("closed"),d(()=>{s.classList.add("done"),s.classList.remove("in-progress"),s.style.transition=null,I.ready+=n.cost.people,n.callback()},r)};let ce,ue;const pe=()=>{clearInterval(ce),clearInterval(ue)},he=()=>{clearInterval(ce),clearInterval(ue),e("#island").style.filter="brightness(.5) contrast(1.0) saturate(0)"},ge=()=>{ce=setInterval(E,R),ue=setInterval(M,R/2),e("#days").classList.remove("paused")},fe=()=>{Z(),X(),e(".intro").classList.add("closed"),e("#sail").beginElement(),e("#sink").beginElement(),e("#sinkRotate").beginElement(),setTimeout(()=>{document.body.style.setProperty("--v","1")},4e3),d(me,4e3)},me=()=>{ce=setInterval(E,R),ue=setInterval(M,R/2),e("#days").classList.remove("paused"),Z(),X(),ie("caravela"),T(),a("People settled by the sea.",null,"⛺️","info"),d(()=>{a(`${G().name} found good foraging grounds nearby.`,"blue","🌾","info"),s("#forage"),s("#restart"),$("forage","blink")},2e3),d(()=>{a(`${G().name} made some rudimentary axes for logging`,"blue","🌳","info"),s("#fetchWood"),$("fetchWood","blink")},R),d(()=>{a("The river can provide you food if you develop fishing.","blue","🐟","info"),$("projects","blink"),ie("fishing")},2*R)};n(e(".intro button"),"click",()=>{o(".actions button").forEach(e=>{n(e,"click",v[e.id])}),n(e("#projects"),"click",()=>{e(".projects").classList.toggle("closed"),e("#requirements").innerText=null}),n(e("#score-board button"),"click",y),fe()}),document.monetization&&"started"===document.monetization.state&&(e("#coil").classList.remove("hidden"),A=.3,x.food=30,F.resources.food=30);